#!/bin/bash

version=0.9.0

echo "CoLTE Log Collection Tool ($version)"

if [ "$EUID" -ne 0 ]; then
	echo "coltelog: Must run as root!"
	exit 1
fi

if [ "$#" -ne 2 ]; then
	echo "coltelog usage: coltelog {time TIMESTRING}"
	echo "note 1: TIMESTRING must be a string for journalctl processing"
	echo "note 2: default TIMESTRING value is \"--since 1 hour ago \""
	exit 1
fi

if [ "$1" = "time" ]; then
	TIMESTRING = "$2"
else
	TIMESTRING = '--since "1 hour ago"'
fi

# QUESTION: SHOULD WE DO ANY VALIDATION OF THE TIMESTRING?!?

DATETIME="20181012_1329"
TARGET_DIR = /tmp/coltelog/log$DATETIME
mkdir -p $TARGET_DIR
sudo journalctl $TIMESTRING -u mme > $TARGET_DIR/mme.log
sudo journalctl $TIMESTRING -u hss > $TARGET_DIR/hss.log
sudo journalctl $TIMESTRING -u spgw > $TARGET_DIR/spgw.log
sudo journalctl $TIMESTRING -u colte_webgui > $TARGET_DIR/webgui.log
sudo journalctl $TIMESTRING -u nginx > $TARGET_DIR/nginx.log
#TODO: TCPDUMP LOGS
tar -zcvf $TARGET_DIR/coltelog_$DATETIME.tar.gz $TARGET_DIR
ln -s $TARGET_DIR/coltelog_$DATETIME.tar.gz /tmp/coltelog/coltelog.tar.gz